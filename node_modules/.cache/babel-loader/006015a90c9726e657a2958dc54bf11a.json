{"ast":null,"code":"import _objectSpread from\"/Users/evik/kl/project-2024/klasmart-assessment-frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _classCallCheck from\"/Users/evik/kl/project-2024/klasmart-assessment-frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _createClass from\"/Users/evik/kl/project-2024/klasmart-assessment-frontend/node_modules/@babel/runtime/helpers/esm/createClass.js\";import{apiEmitter,ApiEvent}from\"../api\";import{apiGetPartPermission,getUserIdAndOrgId}from\"../api/extra\";var PermissionCahce=/*#__PURE__*/function(){function PermissionCahce(){_classCallCheck(this,PermissionCahce);this.cacheKey=\"\";this.data={};}_createClass(PermissionCahce,[{key:\"_add\",value:function _add(cacheKey,data){this.cacheKey=cacheKey;this.data=_objectSpread(_objectSpread({},this.data),data);}},{key:\"_get\",value:function _get(perms){var _this=this;return perms.reduce(function(prev,cur){if(_this.data.hasOwnProperty(cur)){prev[cur]=!!_this.data[cur];}return prev;},{});}},{key:\"flush\",value:function flush(){this.data={};}},{key:\"usePermission\",value:function usePermission(perms){var _this2=this;return new Promise(function(resolve,reject){getUserIdAndOrgId().then(function(orgId){var keyChanged=_this2.cacheKey!==\"\"&&orgId!==_this2.cacheKey;keyChanged&&_this2.flush();var existPerms=keyChanged?{}:_this2._get(perms);var noneExistPerms=keyChanged?perms:perms.filter(function(perm){return!existPerms.hasOwnProperty(perm);});if(noneExistPerms.length===0){resolve(existPerms);}else{apiGetPartPermission(noneExistPerms).then(function(_ref){var error=_ref.error,data=_ref.data;// CMS-200\nif(error){reject();apiEmitter.emit(ApiEvent.GraphQLError,{label:\"general_error_fail_get_permission\"});}else{var permData=noneExistPerms.reduce(function(prev,cur){if(data&&data.hasOwnProperty(cur)&&\"boolean\"===typeof data[cur]){prev[cur]=data[cur];}return prev;},{});_this2._add(orgId,permData);resolve(_objectSpread(_objectSpread({},existPerms),permData));}}).catch(function(error){reject();//\n});}});});}}]);return PermissionCahce;}();export default new PermissionCahce();","map":{"version":3,"names":["apiEmitter","ApiEvent","apiGetPartPermission","getUserIdAndOrgId","PermissionCahce","cacheKey","data","perms","reduce","prev","cur","hasOwnProperty","Promise","resolve","reject","then","orgId","keyChanged","flush","existPerms","_get","noneExistPerms","filter","perm","length","error","emit","GraphQLError","label","permData","_add","catch"],"sources":["/Users/evik/kl/project-2024/klasmart-assessment-frontend/src/services/permissionCahceService.ts"],"sourcesContent":["import { apiEmitter, ApiEvent, GraphQLErrorEventData } from \"../api\";\nimport { apiGetPartPermission, getUserIdAndOrgId, IApiGetPartPermissionResp } from \"../api/extra\";\nimport PermissionType from \"../api/PermissionType\";\n\nexport type ICacheData = {\n  [key in PermissionType]?: boolean;\n};\n\nclass PermissionCahce {\n  private cacheKey = \"\";\n  private data: ICacheData = {};\n\n  private _add(cacheKey: string, data: ICacheData) {\n    this.cacheKey = cacheKey;\n    this.data = {\n      ...this.data,\n      ...data,\n    };\n  }\n\n  private _get(perms: PermissionType[]) {\n    return perms.reduce((prev, cur) => {\n      if (this.data.hasOwnProperty(cur)) {\n        prev[cur] = !!this.data[cur];\n      }\n      return prev;\n    }, {} as ICacheData);\n  }\n\n  private flush() {\n    this.data = {};\n  }\n\n  usePermission(perms: PermissionType[]): Promise<ICacheData> {\n    return new Promise((resolve, reject) => {\n      getUserIdAndOrgId().then((orgId) => {\n        const keyChanged = this.cacheKey !== \"\" && orgId !== this.cacheKey;\n        keyChanged && this.flush();\n        const existPerms = keyChanged ? {} : this._get(perms);\n        const noneExistPerms = keyChanged ? perms : perms.filter((perm) => !existPerms.hasOwnProperty(perm));\n        if (noneExistPerms.length === 0) {\n          resolve(existPerms);\n        } else {\n          apiGetPartPermission(noneExistPerms)\n            .then(({ error, data }: IApiGetPartPermissionResp) => {\n              // CMS-200\n              if (error) {\n                reject();\n                apiEmitter.emit<GraphQLErrorEventData>(ApiEvent.GraphQLError, { label: \"general_error_fail_get_permission\" });\n              } else {\n                const permData = noneExistPerms.reduce((prev, cur) => {\n                  if (data && data.hasOwnProperty(cur) && \"boolean\" === typeof data[cur]) {\n                    prev[cur] = data[cur];\n                  }\n                  return prev;\n                }, {} as ICacheData);\n                this._add(orgId, permData);\n                resolve({\n                  ...existPerms,\n                  ...permData,\n                });\n              }\n            })\n            .catch((error) => {\n              reject();\n              //\n            });\n        }\n      });\n    });\n  }\n}\n\nexport default new PermissionCahce();\n"],"mappings":"uaAAA,OAASA,UAAT,CAAqBC,QAArB,KAA4D,QAA5D,CACA,OAASC,oBAAT,CAA+BC,iBAA/B,KAAmF,cAAnF,C,GAOMC,CAAAA,e,+FACIC,Q,CAAW,E,MACXC,I,CAAmB,E,kDAE3B,cAAaD,QAAb,CAA+BC,IAA/B,CAAiD,CAC/C,KAAKD,QAAL,CAAgBA,QAAhB,CACA,KAAKC,IAAL,gCACK,KAAKA,IADV,EAEKA,IAFL,EAID,C,oBAED,cAAaC,KAAb,CAAsC,gBACpC,MAAOA,CAAAA,KAAK,CAACC,MAAN,CAAa,SAACC,IAAD,CAAOC,GAAP,CAAe,CACjC,GAAI,KAAI,CAACJ,IAAL,CAAUK,cAAV,CAAyBD,GAAzB,CAAJ,CAAmC,CACjCD,IAAI,CAACC,GAAD,CAAJ,CAAY,CAAC,CAAC,KAAI,CAACJ,IAAL,CAAUI,GAAV,CAAd,CACD,CACD,MAAOD,CAAAA,IAAP,CACD,CALM,CAKJ,EALI,CAAP,CAMD,C,qBAED,gBAAgB,CACd,KAAKH,IAAL,CAAY,EAAZ,CACD,C,6BAED,uBAAcC,KAAd,CAA4D,iBAC1D,MAAO,IAAIK,CAAAA,OAAJ,CAAY,SAACC,OAAD,CAAUC,MAAV,CAAqB,CACtCX,iBAAiB,GAAGY,IAApB,CAAyB,SAACC,KAAD,CAAW,CAClC,GAAMC,CAAAA,UAAU,CAAG,MAAI,CAACZ,QAAL,GAAkB,EAAlB,EAAwBW,KAAK,GAAK,MAAI,CAACX,QAA1D,CACAY,UAAU,EAAI,MAAI,CAACC,KAAL,EAAd,CACA,GAAMC,CAAAA,UAAU,CAAGF,UAAU,CAAG,EAAH,CAAQ,MAAI,CAACG,IAAL,CAAUb,KAAV,CAArC,CACA,GAAMc,CAAAA,cAAc,CAAGJ,UAAU,CAAGV,KAAH,CAAWA,KAAK,CAACe,MAAN,CAAa,SAACC,IAAD,QAAU,CAACJ,UAAU,CAACR,cAAX,CAA0BY,IAA1B,CAAX,EAAb,CAA5C,CACA,GAAIF,cAAc,CAACG,MAAf,GAA0B,CAA9B,CAAiC,CAC/BX,OAAO,CAACM,UAAD,CAAP,CACD,CAFD,IAEO,CACLjB,oBAAoB,CAACmB,cAAD,CAApB,CACGN,IADH,CACQ,cAAgD,IAA7CU,CAAAA,KAA6C,MAA7CA,KAA6C,CAAtCnB,IAAsC,MAAtCA,IAAsC,CACpD;AACA,GAAImB,KAAJ,CAAW,CACTX,MAAM,GACNd,UAAU,CAAC0B,IAAX,CAAuCzB,QAAQ,CAAC0B,YAAhD,CAA8D,CAAEC,KAAK,CAAE,mCAAT,CAA9D,EACD,CAHD,IAGO,CACL,GAAMC,CAAAA,QAAQ,CAAGR,cAAc,CAACb,MAAf,CAAsB,SAACC,IAAD,CAAOC,GAAP,CAAe,CACpD,GAAIJ,IAAI,EAAIA,IAAI,CAACK,cAAL,CAAoBD,GAApB,CAAR,EAAoC,YAAc,MAAOJ,CAAAA,IAAI,CAACI,GAAD,CAAjE,CAAwE,CACtED,IAAI,CAACC,GAAD,CAAJ,CAAYJ,IAAI,CAACI,GAAD,CAAhB,CACD,CACD,MAAOD,CAAAA,IAAP,CACD,CALgB,CAKd,EALc,CAAjB,CAMA,MAAI,CAACqB,IAAL,CAAUd,KAAV,CAAiBa,QAAjB,EACAhB,OAAO,gCACFM,UADE,EAEFU,QAFE,EAAP,CAID,CACF,CAnBH,EAoBGE,KApBH,CAoBS,SAACN,KAAD,CAAW,CAChBX,MAAM,GACN;AACD,CAvBH,EAwBD,CACF,CAjCD,EAkCD,CAnCM,CAAP,CAoCD,C,+BAGH,cAAe,IAAIV,CAAAA,eAAJ,EAAf"},"metadata":{},"sourceType":"module"}