{"ast":null,"code":"import _createClass from\"/Users/evik/kl/project-2024/klasmart-assessment-frontend/node_modules/@babel/runtime/helpers/esm/createClass.js\";import _classCallCheck from\"/Users/evik/kl/project-2024/klasmart-assessment-frontend/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";import _inherits from\"/Users/evik/kl/project-2024/klasmart-assessment-frontend/node_modules/@babel/runtime/helpers/esm/inherits.js\";import _createSuper from\"/Users/evik/kl/project-2024/klasmart-assessment-frontend/node_modules/@babel/runtime/helpers/esm/createSuper.js\";import _asyncToGenerator from\"/Users/evik/kl/project-2024/klasmart-assessment-frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _regeneratorRuntime from\"/Users/evik/kl/project-2024/klasmart-assessment-frontend/node_modules/@babel/runtime/regenerator/index.js\";import{ApolloClient,ApolloLink,createHttpLink,HttpLink,InMemoryCache}from\"@apollo/client\";import{onError}from\"@apollo/client/link/error\";import{RetryLink}from\"@apollo/client/link/retry\";import fetchIntercept from\"fetch-intercept\";import{Api as AutoApi}from\"./api.auto\";import{apiEmitter,ApiEvent}from\"./emitter\";import{apiOrganizationOfPage,ORG_ID_KEY,refreshToken}from\"./extra\";export*from\"./emitter\";fetchIntercept.register({request:function request(originUrl,config){try{var organization=apiOrganizationOfPage()||\"\";if(!organization)return[originUrl,config];var URL_REPLACE=\"https://_u_r_l_r_e_p_l_a_c_e_\";var url=new URL(originUrl,URL_REPLACE);if(url.origin.includes(\"kidsloop\")&&originUrl.includes(process.env.REACT_APP_BASE_API)){// 这样改一下：获取s3资源的时候不需要传orgid,不然会报403\nurl.searchParams.append(ORG_ID_KEY,organization);// url.searchParams.delete(ORG_ID_KEY);\n}return[url.toString().replace(URL_REPLACE,\"\"),config];}catch(err){return[originUrl,config];}},response:function response(_response){if(_response.ok)return _response;_response.clone().json().catch(/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(e){var errorLabel;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:errorLabel=\"general_error_unknown\";if(!(_response.status===401||_response.status===400)){_context.next=3;break;}throw _response;case 3:apiEmitter.emit(ApiEvent.ResponseError,{label:errorLabel});case 4:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}());return _response;}});var Api=/*#__PURE__*/function(_AutoApi){_inherits(Api,_AutoApi);var _super=_createSuper(Api);function Api(){var _this;_classCallCheck(this,Api);for(var _len=arguments.length,props=new Array(_len),_key=0;_key<_len;_key++){props[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(props));var originRequest=_this.request;_this.request=function(){for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++){args[_key2]=arguments[_key2];}var params=args[2];var onError=params===null||params===void 0?void 0:params.onError;return originRequest.apply(void 0,args).catch(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(err){var msg,label,data;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!(err.label===\"general_error_unauthorized\")){_context2.next=11;break;}_context2.prev=1;_context2.next=4;return refreshToken();case 4:return _context2.abrupt(\"return\",originRequest.apply(void 0,args));case 7:_context2.prev=7;_context2.t0=_context2[\"catch\"](1);case 9:_context2.next=12;break;case 11:if(err.label&&!err.name){msg=err.msg,label=err.label,data=err.data;err.name=err.label;err.message=err.data;apiEmitter.emit(ApiEvent.ResponseError,{msg:msg,label:label,data:data,onError:onError});}case 12:throw err;case 13:case\"end\":return _context2.stop();}}},_callee2,null,[[1,7]]);}));return function(_x2){return _ref2.apply(this,arguments);};}());};return _this;}return _createClass(Api);}(AutoApi);export default new Api({baseUrl:\"\".concat(process.env.REACT_APP_BASE_DOMAIN).concat(process.env.REACT_APP_BASE_API),baseApiParams:{credentials:\"include\",headers:{\"Content-Type\":\"application/json\"},redirect:\"follow\",referrerPolicy:\"no-referrer\"}});var retry=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(count,operation,error){var isAuthError;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!(count>1)){_context3.next=2;break;}return _context3.abrupt(\"return\",false);case 2:// const isAuthError = error.result?.errors?.find((error: GraphQLError) => error.extensions?.code === `UNAUTHENTICATED`);\nisAuthError=error.result.code===\"UNAUTHORIZED\";if(isAuthError){_context3.next=5;break;}return _context3.abrupt(\"return\",false);case 5:_context3.prev=5;_context3.next=8;return refreshToken();case 8:return _context3.abrupt(\"return\",true);case 11:_context3.prev=11;_context3.t0=_context3[\"catch\"](5);return _context3.abrupt(\"return\",false);case 14:case\"end\":return _context3.stop();}}},_callee3,null,[[5,11]]);}));return function retry(_x3,_x4,_x5){return _ref3.apply(this,arguments);};}();var errorLink=onError(function(_ref4){var graphQLErrors=_ref4.graphQLErrors,networkError=_ref4.networkError,response=_ref4.response,operation=_ref4.operation;if(graphQLErrors)graphQLErrors.forEach(function(_ref5){var message=_ref5.message,locations=_ref5.locations,path=_ref5.path;return void 0;});if(networkError){}if(operation.operationName===\"userNameByUserIdQuery\"&&response){// @ts-ignore\nresponse.errors=null;}});var retryLink=new RetryLink({attempts:function attempts(count,operation,error){return retry(count,operation,error);}});var httpLink=new HttpLink({uri:\"\".concat(process.env.REACT_APP_KO_BASE_API,\"/user/\"),credentials:\"include\"});export var gqlapi=new ApolloClient({link:ApolloLink.from([errorLink,retryLink,httpLink]),cache:new InMemoryCache()});var link=createHttpLink({uri:\"\".concat(process.env.REACT_APP_KO_BASE_API,\"/media-storage/graphql\"),credentials:\"include\"});export var audioClient=new ApolloClient({link:link,cache:new InMemoryCache()});","map":{"version":3,"names":["ApolloClient","ApolloLink","createHttpLink","HttpLink","InMemoryCache","onError","RetryLink","fetchIntercept","Api","AutoApi","apiEmitter","ApiEvent","apiOrganizationOfPage","ORG_ID_KEY","refreshToken","register","request","originUrl","config","organization","URL_REPLACE","url","URL","origin","includes","process","env","REACT_APP_BASE_API","searchParams","append","toString","replace","err","response","ok","clone","json","catch","e","errorLabel","status","emit","ResponseError","label","props","originRequest","args","params","name","msg","data","message","baseUrl","REACT_APP_BASE_DOMAIN","baseApiParams","credentials","headers","redirect","referrerPolicy","retry","count","operation","error","isAuthError","result","code","errorLink","graphQLErrors","networkError","forEach","locations","path","operationName","errors","retryLink","attempts","httpLink","uri","REACT_APP_KO_BASE_API","gqlapi","link","from","cache","audioClient"],"sources":["/Users/evik/kl/project-2024/klasmart-assessment-frontend/src/api/index.ts"],"sourcesContent":["import { ApolloClient, ApolloLink, createHttpLink, HttpLink, InMemoryCache, Operation, ServerError } from \"@apollo/client\";\nimport { ErrorResponse, onError } from \"@apollo/client/link/error\";\nimport { RetryLink } from \"@apollo/client/link/retry\";\nimport fetchIntercept from \"fetch-intercept\";\nimport { LangRecordId } from \"../locale/lang/type\";\nimport { Api as AutoApi, RequestParams } from \"./api.auto\";\nimport { apiEmitter, ApiErrorEventData, ApiEvent } from \"./emitter\";\nimport { apiOrganizationOfPage, ORG_ID_KEY, refreshToken } from \"./extra\";\nexport * from \"./emitter\";\n\nexport type ExtendedRequestParams = RequestParams & Pick<ApiErrorEventData, \"onError\">;\n\nfetchIntercept.register({\n  request: function (originUrl, config: RequestInit) {\n    try {\n      const organization = apiOrganizationOfPage() || \"\";\n      if (!organization) return [originUrl, config];\n      const URL_REPLACE = \"https://_u_r_l_r_e_p_l_a_c_e_\";\n      const url = new URL(originUrl, URL_REPLACE);\n      if (url.origin.includes(\"kidsloop\") && originUrl.includes(process.env.REACT_APP_BASE_API as string)) {\n        // 这样改一下：获取s3资源的时候不需要传orgid,不然会报403\n        url.searchParams.append(ORG_ID_KEY, organization);\n        // url.searchParams.delete(ORG_ID_KEY);\n      }\n      return [url.toString().replace(URL_REPLACE, \"\"), config];\n    } catch (err) {\n      console.error(err);\n      return [originUrl, config];\n    }\n  },\n  response: function (response) {\n    if (response.ok) return response;\n    response\n      .clone()\n      .json()\n      .catch(async (e) => {\n        const errorLabel: LangRecordId = \"general_error_unknown\";\n        console.log(\"e\", response.body);\n        if (response.status === 401 || response.status === 400) throw response;\n        apiEmitter.emit<ApiErrorEventData>(ApiEvent.ResponseError, { label: errorLabel });\n      });\n    return response;\n  },\n});\n\nclass Api extends AutoApi {\n  constructor(...props: ConstructorParameters<typeof AutoApi>) {\n    super(...props);\n    const originRequest = this.request;\n    this.request = (...args) => {\n      const [, , params] = args;\n      const onError = (params as ExtendedRequestParams | undefined)?.onError;\n      return originRequest(...args).catch(async (err) => {\n        if (err.label === \"general_error_unauthorized\") {\n          // 401时 刷新token 重新调接口s\n          try {\n            await refreshToken();\n            return originRequest(...args);\n          } catch (e) {\n            console.log(\"e\", e);\n          }\n        } else if (err.label && !err.name) {\n          const { msg, label, data } = err;\n          err.name = err.label;\n          err.message = err.data;\n          apiEmitter.emit<ApiErrorEventData>(ApiEvent.ResponseError, { msg, label, data, onError });\n        }\n        throw err;\n      });\n    };\n  }\n}\n\nexport default new Api({\n  baseUrl: `${process.env.REACT_APP_BASE_DOMAIN}${process.env.REACT_APP_BASE_API}`,\n  baseApiParams: {\n    credentials: `include`,\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    redirect: \"follow\",\n    referrerPolicy: \"no-referrer\",\n  },\n});\n\nconst retry = async (count: number, operation: Operation, error: ServerError): Promise<boolean> => {\n  if (count > 1) return false;\n  // const isAuthError = error.result?.errors?.find((error: GraphQLError) => error.extensions?.code === `UNAUTHENTICATED`);\n  const isAuthError = error.result.code === `UNAUTHORIZED`;\n  if (!isAuthError) return false;\n  try {\n    await refreshToken();\n    return true;\n  } catch (err) {\n    console.log(\"e\", err);\n    return false;\n  }\n};\n\nconst errorLink = onError(({ graphQLErrors, networkError, response, operation }: ErrorResponse) => {\n  if (graphQLErrors)\n    graphQLErrors.forEach(({ message, locations, path }) =>\n      console.log(`[GraphQL error]: Message: ${message}, Location: ${locations}, Path: ${path}`)\n    );\n  if (networkError) console.log(`[Network error]: ${networkError}`);\n\n  if (operation.operationName === \"userNameByUserIdQuery\" && response) {\n    // @ts-ignore\n    response.errors = null;\n  }\n});\n\nconst retryLink = new RetryLink({\n  attempts: (count, operation, error) => {\n    return retry(count, operation, error);\n  },\n});\nconst httpLink = new HttpLink({ uri: `${process.env.REACT_APP_KO_BASE_API}/user/`, credentials: \"include\" });\nexport const gqlapi = new ApolloClient({\n  link: ApolloLink.from([errorLink, retryLink, httpLink]),\n  cache: new InMemoryCache(),\n});\n\nconst link = createHttpLink({\n  uri: `${process.env.REACT_APP_KO_BASE_API}/media-storage/graphql`,\n  credentials: \"include\",\n});\nexport const audioClient = new ApolloClient({\n  link,\n  cache: new InMemoryCache(),\n});\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}